 
BEGIN
    SET NOCOUNT ON;

    -- Step 1: Retrieve All ClientIDs
    DECLARE @ClientIDs TABLE (ClientID INT PRIMARY KEY);
    INSERT INTO @ClientIDs (ClientID)
    SELECT ClientID FROM fn_DCG_GetClientIDsForDynamicClientID(@DynamicClientID);

    -- Step 2: Prepare SectionIDs
    DECLARE @SectionIDs TABLE (SectionID INT PRIMARY KEY);
    INSERT INTO @SectionIDs (SectionID)
    SELECT randomsectionid FROM randomsection WHERE randomsectionid BETWEEN 1 AND 10;

    -- Step 3: Prepare Temporary Table for Results
    CREATE TABLE #Results (
        SectionID INT,
        UserAvail INT,
        ClientAvail INT,
        SecurityXML VARCHAR(1000)
    );

    -- Step 4: Iterate Over Sections
    DECLARE @SectionID INT;
    DECLARE section_cursor CURSOR LOCAL FAST_FORWARD FOR SELECT SectionID FROM @SectionIDs;
    OPEN section_cursor;
    FETCH NEXT FROM section_cursor INTO @SectionID;
    WHILE @@FETCH_STATUS = 0
    BEGIN
        DECLARE @UserAvail INT = NULL;
        DECLARE @ClientAvail INT = NULL;
        DECLARE @SecurityXML VARCHAR(1000) = NULL;

        -- Iterate Over ClientIDs
        DECLARE @ClientID INT;
        DECLARE client_cursor CURSOR LOCAL FAST_FORWARD FOR SELECT ClientID FROM @ClientIDs;
        OPEN client_cursor;
        FETCH NEXT FROM client_cursor INTO @ClientID;
        WHILE @@FETCH_STATUS = 0
        BEGIN
            -- Call User Random Section Availability Stored Procedure
            EXEC web_Intranet_MyeMgmt_UserRandomSectionAvail
                @ClientID = @ClientID,
                @UserID = @UserID,
                @SectionID = @SectionID,
                @Avail = @UserAvail OUTPUT,
                @SecurityXML = @SecurityXML OUTPUT;

            -- Update UserAvail and SecurityXML if availability is granted
            IF @UserAvail = 1
                SET @UserAvail = 1;

            -- Call Client Random Section Availability Stored Procedure
            EXEC web_Intranet_MyeMgmt_ClientRandomSectionAvail
                @ClientID = @ClientID,
                @SectionID = @SectionID,
                @Avail = @ClientAvail OUTPUT;

            -- Update ClientAvail if availability is granted
            IF @ClientAvail = 1
                SET @ClientAvail = 1;

            -- Exit loops early if availability is confirmed
            IF @UserAvail = 1 AND @ClientAvail = 1
                BREAK;

            FETCH NEXT FROM client_cursor INTO @ClientID;
        END
        CLOSE client_cursor;
        DEALLOCATE client_cursor;

        -- Default to 0 if availability was not set
        SET @UserAvail = ISNULL(@UserAvail, 0);
        SET @ClientAvail = ISNULL(@ClientAvail, 0);

        -- Insert into results
        INSERT INTO #Results (SectionID, UserAvail, ClientAvail, SecurityXML)
        VALUES (@SectionID, @UserAvail, @ClientAvail, @SecurityXML);

        FETCH NEXT FROM section_cursor INTO @SectionID;
    END
    CLOSE section_cursor;
    DEALLOCATE section_cursor;

    -- Step 5: Generate Final Output
    SELECT
        rs.randomsectionid AS RandomSectionID,
        r.UserAvail,
        r.ClientAvail,
        r.SecurityXML,
        rs.menutext AS MenuText,
        rs.menuactionv2 AS MenuActionV2,
        rs.description AS Description
    FROM randomsection rs
    LEFT JOIN #Results r ON r.SectionID = rs.randomsectionid
    WHERE rs.randomsectionid BETWEEN 1 AND 10
    ORDER BY rs.randomsectionid;

    -- Clean up temporary table
    DROP TABLE #Results;
END;
GO
