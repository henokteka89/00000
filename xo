--check relevance
SELECT DISTINCT ca.ClientID
INTO #RelevantClients
FROM #FilteredClients ca
LEFT JOIN myescreenrandomclientsettings rc
    ON rc.ClientID = ca.ClientID
LEFT JOIN myescreenrandomclientsettings rc_group
    ON rc_group.ClientID = ca.GroupID
LEFT JOIN myescreenrandomclientsettings rc_master
    ON rc_master.ClientID = ca.MasterID
WHERE 
    rc.AccessFlag = 1 OR -- Direct Client Access
    rc_group.AccessFlag = 1 OR -- Group Access
    rc_master.AccessFlag = 1; -- Master Access

batch

DECLARE @BatchSize INT = 500;
DECLARE @Start INT = 1, @End INT = @BatchSize, @TotalRows INT;

SELECT @TotalRows = COUNT(*) FROM #FilteredClients;

WHILE @Start <= @TotalRows
BEGIN
    INSERT INTO #ClientAvailability (RandomSectionID, ClientAvail)
    SELECT rs.RandomSectionID,
        MAX(CASE 
            WHEN ca.ClientTypeID = 2 AND rc.AccessFlag = 1 THEN 1
            WHEN ca.ClientTypeID = 1 AND rc.AccessFlag = 1 THEN 1
            WHEN ca.ClientTypeID = 0 AND rc.AccessFlag = 1 THEN 1
            ELSE 0
        END) AS ClientAvail
    FROM #RandomSections rs
    JOIN (
        SELECT * 
        FROM #FilteredClients 
        WHERE ROW_NUMBER() OVER (ORDER BY ClientID) BETWEEN @Start AND @End
    ) ca ON rc.ClientID IN (ca.ClientID, ca.GroupID, ca.MasterID)
    LEFT JOIN myescreenrandomclientsettings rc
        ON rc.ClientID = ca.ClientID AND rc.RandomSectionID = rs.RandomSectionID AND rc.ClientTypeID = ca.ClientTypeID
    GROUP BY rs.RandomSectionID;

    SET @Start = @Start + @BatchSize;
    SET @End = @End + @BatchSize;
END;


    @ClientID INT,
    @DynamicClientID INT,
    @UserID INT
AS
BEGIN
    SET NOCOUNT ON;

    -- Step 1: Retrieve Random Sections
    SELECT RandomSectionID, MenuText, MenuActionV2, Description
    INTO #RandomSections
    FROM randomsection (NOLOCK)
    WHERE RandomSectionID BETWEEN 1 AND 10;

    -- Step 2: Retrieve ClientIDs associated with @DynamicClientID
    SELECT DISTINCT ClientID, 
        CASE 
            WHEN ca.ClientSubAccount <> 0 THEN 0 -- Sub-client
            WHEN EXISTS (SELECT 1 FROM nationalaccountextras na WHERE na.GroupID = ca.ClientID) THEN 2 -- Group
            ELSE 1 -- Master
        END AS ClientTypeID,
        COALESCE(
            (SELECT TOP 1 ClientID 
             FROM clientaccounts 
             WHERE ClientAccount = ca.ClientAccount AND ClientSubAccount = 0), 0) AS MasterID,
        COALESCE(
            (SELECT GroupID 
             FROM nationalaccountextras 
             WHERE ClientID = ca.ClientID), 0) AS GroupID
    INTO #FilteredClients
    FROM clientaccounts ca (NOLOCK)
    WHERE ca.ClientID IN (SELECT EntityID FROM fn_GetClientIDsForDynamicClientID(@DynamicClientID));

    -- Step 3: Initialize Availability Tables
    CREATE TABLE #UserAvailability (RandomSectionID INT, UserAvail INT);
    CREATE TABLE #ClientAvailability (RandomSectionID INT, ClientAvail INT);

    -- Step 4: Determine User Availability (Set-based)
    INSERT INTO #UserAvailability (RandomSectionID, UserAvail)
    SELECT 
        rs.RandomSectionID,
        CASE
            WHEN EXISTS (
                SELECT 1 FROM myescreenrandomusersettings uss (NOLOCK)
                WHERE uss.UserID = @UserID AND uss.RandomSectionID = rs.RandomSectionID AND uss.accessflag = 0
            ) THEN 0 -- Denied
            WHEN EXISTS (
                SELECT 1 FROM myescreenrandomusersettings uss (NOLOCK)
                WHERE uss.UserID = @UserID AND uss.RandomSectionID = rs.RandomSectionID AND uss.accessflag = 1
            ) THEN 1 -- Granted
            ELSE NULL -- No setting
        END AS UserAvail
    FROM #RandomSections rs;

    -- Step 5: Compute Client Availability (Set-based)
    INSERT INTO #ClientAvailability (RandomSectionID, ClientAvail)
    SELECT 
        rs.RandomSectionID,
        MAX(CASE 
            WHEN ca.ClientTypeID = 2 AND rc.AccessFlag = 1 THEN 1 -- Group Level Access
            WHEN ca.ClientTypeID = 1 AND rc.AccessFlag = 1 THEN 1 -- Master Level Access
            WHEN ca.ClientTypeID = 0 AND rc.AccessFlag = 1 THEN 1 -- Client Level Access
            ELSE 0 -- Default Denied
        END) AS ClientAvail
    FROM #RandomSections rs
    CROSS JOIN #FilteredClients ca
    LEFT JOIN myescreenrandomclientsettings rc (NOLOCK)
        ON rc.ClientID IN (ca.ClientID, ca.GroupID, ca.MasterID)
        AND rc.RandomSectionID = rs.RandomSectionID
        AND rc.ClientTypeID = ca.ClientTypeID
    GROUP BY rs.RandomSectionID;

    -- Step 6: Combine Results
    SELECT ca.ClientAvail,
        CASE 
            WHEN ua.UserAvail = 0 THEN 0 -- User Denied
            WHEN ca.ClientAvail = 1 
                 AND ua.UserAvail = 1 THEN 1 -- Both User and Client Granted
            ELSE 0 -- Denied
        END AS UserAvail,
        rs.MenuText,
        rs.MenuActionV2,
        rs.RandomSectionID,
        rs.Description
    FROM #RandomSections rs
    LEFT JOIN #ClientAvailability ca ON ca.RandomSectionID = rs.RandomSectionID
    LEFT JOIN #UserAvailability ua ON ua.RandomSectionID = rs.RandomSectionID;

    -- Cleanup
    DROP TABLE #RandomSections;
    DROP TABLE #FilteredClients;
    DROP TABLE #UserAvailability;
    DROP TABLE #ClientAvailability;

    SET NOCOUNT OFF;
END;
GO
