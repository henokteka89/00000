 
BEGIN
    SET NOCOUNT ON;

    -- Temporary tables
    CREATE TABLE #SecurityXMLResult (
        RandomSectionID INT PRIMARY KEY,
        SecurityXML VARCHAR(1000) NULL
    );

    CREATE TABLE #ClientIDs (
        ClientID INT PRIMARY KEY
    );

    -- Retrieve ClientIDs associated with @DynamicClientID
    INSERT INTO #ClientIDs (ClientID)
    SELECT ClientID 
    FROM fn_DCG_GetClientIDsForDynamicClientID(@DynamicClientID);

    -- Iterate over each RandomSectionID (1 to 10)
    DECLARE @RandomSectionID INT = 1;

    WHILE @RandomSectionID <= 10
    BEGIN
        DECLARE @UserSectionAvail INT = NULL;
        DECLARE @UserSecurityXML VARCHAR(1000) = NULL;
        DECLARE @ClientSecurityXML VARCHAR(1000) = NULL;
        DECLARE @FinalSecurityXML VARCHAR(1000) = NULL;

        -- Step 1: Check User-Level Settings
        SELECT 
            @UserSectionAvail = accessflag,
            @UserSecurityXML = SecurityXML
        FROM myescreenrandomusersectionsettings WITH (NOLOCK)
        WHERE UserID = @UserID AND RandomSectionID = @RandomSectionID;

        -- If User is denied or has explicit SecurityXML
        IF @UserSectionAvail = 0
        BEGIN
            SET @FinalSecurityXML = @UserSecurityXML;
        END
        ELSE IF @UserSecurityXML IS NOT NULL
        BEGIN
            SET @FinalSecurityXML = @UserSecurityXML;
        END

        -- Step 2: Check Client-Level Settings if User-level doesn't set SecurityXML
        IF @FinalSecurityXML IS NULL
        BEGIN
            -- Cursor for each ClientID
            DECLARE ClientCursor CURSOR LOCAL FAST_FORWARD FOR
            SELECT ClientID FROM #ClientIDs;

            DECLARE @ClientID INT;
            DECLARE @ClientAccount INT;
            DECLARE @ClientSubAccount INT;
            DECLARE @ClientTypeID INT;
            DECLARE @MasterID INT;
            DECLARE @GroupID INT;

            OPEN ClientCursor;
            FETCH NEXT FROM ClientCursor INTO @ClientID;

            WHILE @@FETCH_STATUS = 0
            BEGIN
                -- Get Client Account Information
                SELECT 
                    @ClientAccount = ClientAccount, 
                    @ClientSubAccount = ClientSubAccount
                FROM clientaccounts WITH (NOLOCK)
                WHERE ClientID = @ClientID;

                SELECT @GroupID = GroupID
                FROM nationalaccountextras WITH (NOLOCK)
                WHERE ClientID = @ClientID;

                -- Determine ClientTypeID
                IF @ClientSubAccount <> 0
                BEGIN
                    SET @ClientTypeID = 0; -- Subclient
                    SELECT @MasterID = ClientID
                    FROM clientaccounts WITH (NOLOCK)
                    WHERE ClientAccount = @ClientAccount AND ClientSubAccount = 0;
                END
                ELSE
                BEGIN
                    IF EXISTS (SELECT 1 FROM nationalaccountextras WHERE GroupID = @ClientID)
                    BEGIN
                        SET @ClientTypeID = 2; -- Group
                    END
                    ELSE
                    BEGIN
                        SET @ClientTypeID = 1; -- Master
                    END
                END

                -- Check Client Settings Based on ClientTypeID
                IF @ClientTypeID = 2
                BEGIN
                    SELECT TOP 1 @ClientSecurityXML = SECURITYXML
                    FROM myescreenrandomclientsectionsettings WITH (NOLOCK)
                    WHERE ClientID = @ClientID AND ClientTypeID = 2 AND RandomSectionID = @RandomSectionID;

                    IF @ClientSecurityXML IS NOT NULL
                    BEGIN
                        SET @FinalSecurityXML = @ClientSecurityXML;
                    END
                END
                ELSE IF @ClientTypeID = 1
                BEGIN
                    SELECT TOP 1 @ClientSecurityXML = SECURITYXML
                    FROM myescreenrandomclientsectionsettings WITH (NOLOCK)
                    WHERE ClientID = @ClientID AND ClientTypeID = 1 AND RandomSectionID = @RandomSectionID;

                    IF @ClientSecurityXML IS NOT NULL
                    BEGIN
                        SET @FinalSecurityXML = @ClientSecurityXML;
                    END

                    -- Check Group Level
                    IF @GroupID IS NOT NULL AND @FinalSecurityXML IS NULL
                    BEGIN
                        SELECT TOP 1 @ClientSecurityXML = SECURITYXML
                        FROM myescreenrandomclientsectionsettings WITH (NOLOCK)
                        WHERE ClientID = @GroupID AND ClientTypeID = 1 AND RandomSectionID = @RandomSectionID;

                        IF @ClientSecurityXML IS NOT NULL
                        BEGIN
                            SET @FinalSecurityXML = @ClientSecurityXML;
                        END
                    END
                END
                ELSE IF @ClientTypeID = 0
                BEGIN
                    SELECT TOP 1 @ClientSecurityXML = SECURITYXML
                    FROM myescreenrandomclientsectionsettings WITH (NOLOCK)
                    WHERE ClientID = @ClientID AND ClientTypeID = 0 AND RandomSectionID = @RandomSectionID;

                    IF @ClientSecurityXML IS NOT NULL
                    BEGIN
                        SET @FinalSecurityXML = @ClientSecurityXML;
                    END

                    -- Check Master Level
                    IF @MasterID IS NOT NULL AND @FinalSecurityXML IS NULL
                    BEGIN
                        SELECT TOP 1 @ClientSecurityXML = SECURITYXML
                        FROM myescreenrandomclientsectionsettings WITH (NOLOCK)
                        WHERE ClientID = @MasterID AND ClientTypeID = 0 AND RandomSectionID = @RandomSectionID;

                        IF @ClientSecurityXML IS NOT NULL
                        BEGIN
                            SET @FinalSecurityXML = @ClientSecurityXML;
                        END
                    END

                    -- Check Group Level
                    IF @GroupID IS NOT NULL AND @FinalSecurityXML IS NULL
                    BEGIN
                        SELECT TOP 1 @ClientSecurityXML = SECURITYXML
                        FROM myescreenrandomclientsectionsettings WITH (NOLOCK)
                        WHERE ClientID = @GroupID AND ClientTypeID = 0 AND RandomSectionID = @RandomSectionID;

                        IF @ClientSecurityXML IS NOT NULL
                        BEGIN
                            SET @FinalSecurityXML = @ClientSecurityXML;
                        END
                    END
                END

                FETCH NEXT FROM ClientCursor INTO @ClientID;
            END

            CLOSE ClientCursor;
            DEALLOCATE ClientCursor;
        END

        -- Insert result for current RandomSectionID
        INSERT INTO #SecurityXMLResult (RandomSectionID, SecurityXML)
        VALUES (@RandomSectionID, @FinalSecurityXML);

        -- Move to next section
        SET @RandomSectionID = @RandomSectionID + 1;
    END

    -- Output results
    SELECT RandomSectionID, SecurityXML
    FROM #SecurityXMLResult
    ORDER BY RandomSectionID;

    -- Cleanup
    DROP TABLE #SecurityXMLResult;
    DROP TABLE #ClientIDs;
END;
GO
