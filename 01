WITH RandomSections AS (
    -- Step 1: Random sections (1 to 10)
    SELECT RandomSectionID, MenuText, MenuActionV2, Description
    FROM randomsection
    WHERE RandomSectionID BETWEEN 1 AND 10
),
ClientHierarchy AS (
    -- Step 2: Client hierarchy
    SELECT 
        ca.ClientID,
        ca.ClientAccount,
        ca.ClientSubAccount,
        COALESCE(nae.GroupID, 0) AS GroupID,
        CASE
            WHEN ca.ClientSubAccount <> 0 THEN 0 -- Subclient
            WHEN EXISTS (SELECT 1 FROM nationalaccountextras WHERE GroupID = ca.ClientID) THEN 2 -- Group
            ELSE 1 -- Master
        END AS ClientTypeID,
        COALESCE(m.ClientID, 0) AS MasterID
    FROM clientaccounts ca
    LEFT JOIN nationalaccountextras nae ON nae.ClientID = ca.ClientID
    LEFT JOIN clientaccounts m ON m.ClientAccount = ca.ClientAccount AND m.ClientSubAccount = 0
    WHERE ca.ClientID IN (SELECT ClientID FROM fn_DCG_GetClientIDsForDynamicClientID(@DynamicClientID))
),
UserSettings AS (
    -- Step 3: User-level access and XML
    SELECT
        rs.RandomSectionID,
        us.UserID,
        MAX(CASE WHEN us.AccessFlag = 0 THEN 0 WHEN us.AccessFlag = 1 THEN 1 ELSE NULL END) AS UserAccess,
        MAX(us.SecurityXML) AS UserSecurityXML
    FROM RandomSections rs
    LEFT JOIN myescreenrandomusersectionsettings us 
        ON rs.RandomSectionID = us.RandomSectionID AND us.UserID = @UserID
    GROUP BY rs.RandomSectionID, us.UserID
),
ClientSettings AS (
    -- Step 4: Client-level access and XML for all hierarchy levels
    SELECT 
        rs.RandomSectionID,
        ch.ClientID,
        MAX(CASE WHEN cs.AccessFlag = 0 THEN 0 WHEN cs.AccessFlag = 1 THEN 1 ELSE NULL END) AS ClientAccess,
        MAX(cs.SecurityXML) AS ClientSecurityXML
    FROM RandomSections rs
    CROSS APPLY (
        SELECT ch.ClientID, ch.ClientID AS ClientIDToCheck, ch.ClientTypeID
        FROM ClientHierarchy ch
        UNION ALL
        SELECT ch.ClientID, ch.MasterID AS ClientIDToCheck, ch.ClientTypeID
        FROM ClientHierarchy ch WHERE ch.MasterID IS NOT NULL
        UNION ALL
        SELECT ch.ClientID, ch.GroupID AS ClientIDToCheck, ch.ClientTypeID
        FROM ClientHierarchy ch WHERE ch.GroupID IS NOT NULL
    ) ch
    LEFT JOIN myescreenrandomclientsectionsettings cs
        ON rs.RandomSectionID = cs.RandomSectionID
        AND ch.ClientIDToCheck = cs.ClientID
        AND ch.ClientTypeID = cs.ClientTypeID
    GROUP BY rs.RandomSectionID, ch.ClientID
),
FinalResults AS (
    -- Step 5: Combine user and client settings
    SELECT
        rs.RandomSectionID,
        rs.MenuText,
        rs.MenuActionV2,
        rs.Description,
        COALESCE(us.UserSecurityXML, cs.ClientSecurityXML) AS FinalSecurityXML,
        CASE
            WHEN us.UserAccess = 0 THEN 0 -- User Denied
            WHEN cs.ClientAccess = 1 AND us.UserAccess = 1 THEN 1 -- Both Granted
            ELSE 0 -- Default Denied
        END AS FinalAccess
    FROM RandomSections rs
    LEFT JOIN UserSettings us ON rs.RandomSectionID = us.RandomSectionID
    LEFT JOIN ClientSettings cs ON rs.RandomSectionID = cs.RandomSectionID
)
-- Final Output
SELECT DISTINCT
    fr.RandomSectionID,
    fr.MenuText,
    fr.MenuActionV2,
    fr.Description,
    fr.FinalSecurityXML,
    fr.FinalAccess
FROM FinalResults fr
ORDER BY fr.RandomSectionID;
