SELECT
    rs.RandomSectionID,
    uss.SecurityXML AS UserSecurityXML,
    CASE
        WHEN EXISTS (
            SELECT 1 FROM myescreenrandomusersectionsettings uss
            WHERE uss.UserID = @UserID AND uss.RandomSectionID = rs.RandomSectionID AND uss.accessflag = 0
        ) THEN 'Denied'
        WHEN EXISTS (
            SELECT 1 FROM myescreenrandomusersectionsettings uss
            WHERE uss.UserID = @UserID AND uss.RandomSectionID = rs.RandomSectionID AND uss.accessflag = 1
        ) THEN 'Granted'
        ELSE 'No Setting'
    END AS UserAccess
FROM randomsection rs
LEFT JOIN myescreenrandomusersectionsettings uss
ON rs.RandomSectionID = uss.RandomSectionID AND uss.UserID = @UserID;


SELECT
    rs.RandomSectionID,
    csa.ClientID,
    csa.SECURITYXML AS ClientSecurityXML
FROM randomsection rs
LEFT JOIN myescreenrandomclientsectionsettings csa
ON rs.RandomSectionID = csa.RandomSectionID
WHERE csa.ClientID IN (
    SELECT ClientID FROM fn_DCG_GetClientIDsForDynamicClientID(@DynamicClientID)
);

SELECT
    rs.RandomSectionID,
    u.UserSecurityXML,
    c.ClientSecurityXML,
    COALESCE(u.UserSecurityXML, c.ClientSecurityXML) AS FinalSecurityXML
FROM randomsection rs
LEFT JOIN #UserSecurityXML u ON rs.RandomSectionID = u.RandomSectionID
LEFT JOIN (
    SELECT RandomSectionID, MAX(ClientSecurityXML) AS ClientSecurityXML
    FROM #ClientSecurityXML
    GROUP BY RandomSectionID
) c ON rs.RandomSectionID = c.RandomSectionID;


-- Final Aggregation with Explicit Precedence
SELECT
    rs.RandomSectionID,
    CASE
        WHEN ua.UserAvail = 0 THEN NULL -- User explicitly denied
        ELSE COALESCE(ua.UserSecurityXML, ca.ClientSecurityXML, NULL) -- User takes precedence
    END AS FinalSecurityXML
FROM #RandomSections rs
LEFT JOIN #UserSecurityXML ua ON rs.RandomSectionID = ua.RandomSectionID
LEFT JOIN (
    SELECT RandomSectionID, MAX(ClientSecurityXML) AS ClientSecurityXML
    FROM #ClientSecurityXML
    GROUP BY RandomSectionID
) ca ON rs.RandomSectionID = ca.RandomSectionID;



